<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>音乐播放器</title>
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    .musicbox {
      font-family: cursive, microsoft Yahei;
      font-size: 16px;
      color: #f06d6a;
      border: 1px solid #76dba3;
      width: 340px;
      padding: 20px 20px 5px 20px;
      box-shadow: 0px 2px 5px 0px rgba(0, 0, 0, 0.1), 0px 2px 10px 0px rgba(0, 0, 0, 0.05);
      -webkit-font-smoothing: antialiased;
    }
    
    .musicbox .control {
      margin-top: 20px;
      font-size: 22px;
      color: #ee8a87;
      float: left;
    }
    
    .musicbox .control .fa {
      margin-right: 12px;
      cursor: pointer;
    }
    
    .musicbox .control .fa.disable {
      opacity: 0.3;
    }
    
    .musicbox .info {
      margin-left: 120px;
    }
    
    .musicbox .info .title {
      font-size: 18px;
    }
    
    .musicbox .info .auther {
      font-size: 13px;
    }
    
    .musicbox .progress {
      width: 260px;
    }
    
    .musicbox .progress .bar {
      height: 3px;
      margin-top: 5px;
      background-color: rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }
    
    .musicbox .progress .progress-now {
      background-color: #ee8a87;
      height: 3px;
      width: 0;
      position: relative;
    }
    
    .musicbox .time {
      text-align: right;
    }
    
    .musicbox:after,
    .musicbox .music:after {
      content: '';
      display: block;
      clear: both;
    }
  </style>
</head>

<body>
  <div class="musicbox">
    <div class="music">
      <div class="control">
        <span class="back"><i class="fa fa-step-backward"></i></span>
        <span class="play"><i class="fa fa-pause"></i></span>
        <span class="forward"><i class="fa fa-step-forward"></i></span>
      </div>
      <div class="info">
        <div class="title">My song</div>
        <div class="auther">ruoyu</div>
      </div>
    </div>

    <div class="progress">
      <div class="bar">
        <div class="progress-total"></div>
        <div class="progress-now"></div>
      </div>

      <div class="time">0:00</div>
    </div>

  </div>

  <script>
    var musicList = [{
      src: 'http://cloud.hunger-valley.com/music/ifyou.mp3',
      title: 'IF YOU',
      auther: 'Big Bang'
    }, {
      src: 'http://cloud.hunger-valley.com/music/玫瑰.mp3',
      title: '玫瑰',
      auther: '贰佰'
    }]
    /*
        function Player(ct, musicList){
          this.ct = ct
          this.musicList = musicList
          this.init()
          this.bind()
          this.start()
        }
        Player.prototype = {
          init: function(){
              this.backBtn = this.ct.querySelector('.back')
          },
          bind: function(){
          },
          start: function(){
          }
        }
        new Player(musicList)
    */
  /*
    var musicList = [{
        src: 'http://cloud.hunger-valley.com/music/玫瑰.mp3',
        title: '玫瑰',
        auther: '贰佰'
      }, {
        src: 'http://cloud.hunger-valley.com/music/ifyou.mp3',
        title: 'IF YOU',
        auther: 'Big Bang'
      }
    ]
    */
    var backBtn = document.querySelector('.musicbox .back')
    var playBtn = document.querySelector('.musicbox .play')
    var forwardBtn = document.querySelector('.musicbox .forward')
    var titleNode = document.querySelector('.musicbox .title')
    var authorNode = document.querySelector('.musicbox .auther')
    var timeNode = document.querySelector('.musicbox .time')
    var progressBarNode = document.querySelector('.musicbox .progress .bar')
    var progressNowNode = document.querySelector('.musicbox .progress-now')
    var timer
    var music = new Audio()
    music.autoplay = true
    var musicIndex = 0
    getMusic(function(musicList){
      loadMusic(musicList[musicIndex])
    })
    
    //播放状态切换
    playBtn.onclick = function() {
      var icon = this.querySelector('.fa')
      if (icon.classList.contains('fa-play')) {
        music.play()
      } else {
        music.pause()
      }
      //播放按钮图标切换
      icon.classList.toggle('fa-play')
      icon.classList.toggle('fa-pause')
    }
    //下一曲按钮 
    forwardBtn.onclick = loadNextMusic
    //上一曲按钮
    backBtn.onclick = loadLastMusic
    //一曲完结就下一曲
    music.onended = loadNextMusic
    music.shouldUpdate = true
    //音乐时间进度条
    music.onplaying = function() {
      timer = setInterval(function() {
        updateProgress()
      }, 1000)
      console.log('play')
    }
    //暂停停止进度条计时器
    music.onpause = function() {
        console.log('pause')
        clearInterval(timer)
      }
      /*
      music.ontimeupdate = function(){
        var _this = this
        if(_this.shouldUpdate) { 
           updateProgress()
           _this.shouldUpdate = false
          setTimeout(function(){
            _this.shouldUpdate = true
          }, 1000)
        }
      }
      */

    //点击音乐进度条某位置，音乐跳转播放相应位置
    progressBarNode.onclick = function(e) {
      var percent = e.offsetX / parseInt(getComputedStyle(this).width)
      music.currentTime = percent * music.duration
      progressNowNode.style.width = percent * 100 + "%"
    }
    function loadMusic(songObj) {
      music.src = songObj.src
      titleNode.innerText = songObj.title
      authorNode.innerText = songObj.auther
    }
    //下一曲
    function loadNextMusic() {
      musicIndex++
      musicIndex = musicIndex % musicList.length
      loadMusic(musicList[musicIndex])
    }
    //上一曲
    function loadLastMusic() {
      musicIndex--
      musicIndex = (musicIndex + musicList.length) % musicList.length
      loadMusic(musicList[musicIndex])
    }
    //播放时间更新
    function updateProgress() {
      var percent = (music.currentTime / music.duration) * 100 + '%'
      progressNowNode.style.width = percent
      var minutes = parseInt(music.currentTime / 60)
      var seconds = parseInt(music.currentTime % 60) + ''
      seconds = seconds.length == 2 ? seconds : '0' + seconds
      timeNode.innerText = minutes + ':' + seconds
    }
    //异步获取json文件中的音乐列表
    function getMusic(callback) {
      var xhr = new XMLHttpRequest()
      xhr.open('get', 'music.json', true)
      xhr.send()
      xhr.onload = function() {
        if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
          callback(JSON.parse(xhr.responseText))
        }
      }
    }
  </script>
</body>

</html>